<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìú Á∑®ÈõÜÂ±•Ê≠¥‰∏ÄË¶ß</title>
  <link rel="stylesheet" href="assets/style.css?v=8">
  <script src="assets/sidebar.js" defer></script>

  <style>
    /* ===== „Ç´„Éº„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà ===== */
    .post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .post-card {
      background: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .post-card:hover {
      transform: translateY(-3px);
    }

    .post-thumb {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .post-info {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .post-site {
      color: #47bcec;
      font-size: 14px;
      font-weight: bold;
    }

    .post-title {
      font-size: 16px;
      color: #fff;
      text-decoration: none;
    }

    .post-title:hover {
      color: #5fd0ff;
    }

    .btn-area {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .edit-btn, .delete-btn {
      flex: 1;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .edit-btn {
      background: #47bcec;
      color: #111;
    }

    .edit-btn:hover {
      background: #5fd0ff;
    }

    .delete-btn {
      background: #ff4d4d;
      color: #fff;
    }

    .delete-btn:hover {
      background: #ff6666;
    }

    /* ===== Ê§úÁ¥¢„Éê„Éº ===== */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    #searchInput {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: none;
      background: #1e1e1e;
      color: #eee;
      font-size: 15px;
    }

    #sortBtn {
      background: #333;
      border: 1px solid #47bcec;
      color: #47bcec;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    #sortBtn:hover {
      background: #47bcec;
      color: #111;
    }

    /* ===== „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ ===== */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 30px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pagination button {
      background: #1e1e1e;
      border: 1px solid #47bcec;
      color: #47bcec;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      min-width: 32px;
      transition: all 0.2s ease;
    }

    .pagination button:hover {
      background: #47bcec;
      color: #111;
    }

    .pagination button.active {
      background: #47bcec;
      color: #111;
      font-weight: bold;
    }

    .pagination span {
      color: #666;
      user-select: none;
    }
  </style>
</head>

<body>
  <main class="main-content">
    <h1 class="main-title">üìú Á∑®ÈõÜÂ±•Ê≠¥‰∏ÄË¶ß</h1>

    <!-- üîç Ê§úÁ¥¢„Éª‰∏¶„Å≥Êõø„Åà -->
    <section class="section filter-bar">
      <input type="text" id="searchInput" placeholder="üîç „Çø„Ç§„Éà„É´„ÉªÁ∑®ÈõÜËÄÖ„Éª„Çø„Ç∞„ÅßÊ§úÁ¥¢" />
      <button id="sortBtn">‚¨áÔ∏è ÈôçÈ†Ü</button>
    </section>

    <!-- üß± Â±•Ê≠¥„Ç´„Éº„Éâ‰∏ÄË¶ß -->
    <section class="section">
      <div id="postGrid" class="post-grid"></div>
      <div id="pagination" class="pagination"></div>
    </section>
  </main>

 <script>
  let historyData = [];
  let sortDesc = true;
  let currentPage = 1;
  const perPage = 30;

  const encodeToBase64 = (str) => btoa(unescape(encodeURIComponent(str)));

  // ‚úÖ ÂÖ®Ëßí„ÉªÂçäËßí„ÉªÂ§ßÊñáÂ≠ó„ÉªÂ∞èÊñáÂ≠ó„ÇíÁµ±‰∏Ä„Åó„Å¶Ê§úÁ¥¢Á≤æÂ∫¶UP
  function normalizeText(text) {
    return (text || "")
      .toString()
      .toLowerCase()
      .normalize("NFKC")
      .replace(/\s+/g, "");
  }

  async function loadHistory() {
    const res = await fetch("./history.json", { cache: "no-cache" });
    historyData = await res.json();
    renderHistory();
  }

  function renderHistory() {
    const grid = document.getElementById("postGrid");
    const keywordRaw = document.getElementById("searchInput").value.trim();

    // ‚úÖ „ÄåËàπÈï∑ 10Êúà„Äç„Å™„Å©„ÅÆË§áÊï∞„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÁ©∫ÁôΩÂå∫Âàá„Çä„ÅßÂàÜÂâ≤
    const keywords = keywordRaw
      .split(/\s+/)
      .map(k => normalizeText(k))
      .filter(k => k.length > 0);

    let filtered = historyData.filter(p => {
      const title = normalizeText(p.title_final || p.title_original || "");
      const editor = normalizeText(p.editor || "");
      const tags = normalizeText((p.tags || []).join(","));
      const month = normalizeText(p.month || "");
      const date = normalizeText(p.date || "");

      // ‚úÖ „Åô„Åπ„Å¶„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Åå„Å©„Åì„Åã„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàANDÊ§úÁ¥¢Ôºâ
      return keywords.every(k =>
        title.includes(k) ||
        editor.includes(k) ||
        tags.includes(k) ||
        month.includes(k) ||
        date.includes(k)
      );
    });

    filtered.sort((a, b) => sortDesc
      ? new Date(b.updated_at) - new Date(a.updated_at)
      : new Date(a.updated_at) - new Date(b.updated_at)
    );

    const totalPages = Math.ceil(filtered.length / perPage);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    const start = (currentPage - 1) * perPage;
    const pageData = filtered.slice(start, start + perPage);

    grid.innerHTML = "";
    pageData.forEach(p => {
      const card = document.createElement("div");
      card.className = "post-card";
      card.innerHTML = `
        <img src="${p.thumb_pick1 || p.thumb_original || 'no-thumb.jpg'}" class="post-thumb" alt="thumb">
        <div class="post-info">
          <div class="post-site">${p.editor || "ËàπÈï∑"}</div>
          <div class="post-title">${p.title_final || "(„Çø„Ç§„Éà„É´Êú™Ë®≠ÂÆö)"}</div>
          <div class="post-site">${p.month || ""} Ôºè ${p.date || ""}</div>
          <div class="btn-area">
            <button class="edit-btn" onclick="editPost('${p.id}')">‚úè Á∑®ÈõÜ</button>
            <button class="delete-btn" onclick="deletePost('${p.id}')">üóë ÂâäÈô§</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    if (totalPages <= 1) return;

    const createBtn = (label, page, disabled = false, active = false) => {
      const btn = document.createElement("button");
      btn.textContent = label;
      if (disabled) btn.disabled = true;
      if (active) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = page;
        renderHistory();
      });
      return btn;
    };

    container.appendChild(createBtn("‚èÆ", currentPage - 1, currentPage === 1));

    const visibleRange = 2;
    const startPage = Math.max(1, currentPage - visibleRange);
    const endPage = Math.min(totalPages, currentPage + visibleRange);

    if (startPage > 1) {
      container.appendChild(createBtn("1", 1));
      if (startPage > 2)
        container.appendChild(document.createElement("span")).textContent = "‚Ä¶";
    }

    for (let i = startPage; i <= endPage; i++) {
      container.appendChild(createBtn(i, i, false, i === currentPage));
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1)
        container.appendChild(document.createElement("span")).textContent = "‚Ä¶";
      container.appendChild(createBtn(totalPages, totalPages));
    }

    container.appendChild(createBtn("‚è≠", currentPage + 1, currentPage === totalPages));
  }

  // Á∑®ÈõÜ„Éö„Éº„Ç∏ÈÅ∑Áßª
  function editPost(id) {
    window.location.href = `edit-post.html?id=${id}`;
  }

  // ÂâäÈô§Âá¶ÁêÜÔºàÊó¢Â≠ò„ÅÆ„Åæ„Åæ„ÅßOKÔºâ
  async function deletePost(id) {
    if (!confirm("„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
    try {
      const res = await fetch("history.json", { cache: "no-cache" });
      const data = await res.json();
      const updated = data.filter(p => String(p.id) !== String(id));

      const saveRes = await fetch("https://github-writer.eda-ksuke.workers.dev", {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: "Delete post from history",
          target: "history.json",
          content: encodeToBase64(JSON.stringify(updated, null, 2))
        })
      });

      if (saveRes.ok) {
        alert("üóë Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ");
        loadHistory();
      } else {
        alert("‚ö†Ô∏è ÂâäÈô§Â§±Êïó: " + saveRes.status);
      }
    } catch (err) {
      console.error("ÂâäÈô§„Ç®„É©„Éº:", err);
      alert("‚ö†Ô∏è ÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
    }
  }

  document.getElementById("searchInput").addEventListener("input", () => {
    currentPage = 1;
    renderHistory();
  });

  document.getElementById("sortBtn").addEventListener("click", () => {
    sortDesc = !sortDesc;
    document.getElementById("sortBtn").textContent = sortDesc ? "‚¨áÔ∏è ÈôçÈ†Ü" : "‚¨ÜÔ∏è ÊòáÈ†Ü";
    renderHistory();
  });

  loadHistory();
</script>
</body>
</html>
