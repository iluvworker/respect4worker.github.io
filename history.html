<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“œ ç·¨é›†å±¥æ­´ä¸€è¦§</title>
  <link rel="stylesheet" href="assets/style.css?v=8">
  <script src="assets/sidebar.js" defer></script>

  <style>
    /* ===== ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    .post-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; }
    .post-card { background:#1e1e1e; border-radius:10px; overflow:hidden; box-shadow:0 0 6px rgba(0,0,0,.4); transition:.2s; display:flex; flex-direction:column; }
    .post-card:hover { transform: translateY(-3px); }
    .post-thumb { width:100%; height:180px; object-fit:cover; background:#111; }
    .post-info { padding:15px; display:flex; flex-direction:column; gap:6px; }
    .post-site { color:#47bcec; font-size:14px; font-weight:700; }
    .post-title { font-size:16px; color:#fff; text-decoration:none; }
    .post-title:hover { color:#5fd0ff; }
    .btn-area { display:flex; gap:8px; margin-top:10px; }
    .edit-btn,.delete-btn{ flex:1; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; }
    .edit-btn{ background:#47bcec; color:#111; } .edit-btn:hover{ background:#5fd0ff; }
    .delete-btn{ background:#ff4d4d; color:#fff; } .delete-btn:hover{ background:#ff6666; }

    /* ===== æ¤œç´¢ãƒãƒ¼ ===== */
    .filter-bar{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px; margin-bottom:20px; }
    #searchInput{ flex:1; padding:10px; border-radius:6px; border:none; background:#1e1e1e; color:#eee; font-size:15px; }
    #sortBtn{ background:#333; border:1px solid #47bcec; color:#47bcec; padding:8px 12px; border-radius:6px; cursor:pointer; }
    #sortBtn:hover{ background:#47bcec; color:#111; }

    /* ===== ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ ===== */
    .pagination{ display:flex; justify-content:center; align-items:center; margin-top:30px; gap:8px; flex-wrap:wrap; }
    .pagination button{ background:#1e1e1e; border:1px solid #47bcec; color:#47bcec; padding:6px 10px; border-radius:5px; cursor:pointer; min-width:32px; transition:.2s; }
    .pagination button:hover{ background:#47bcec; color:#111; }
    .pagination button.active{ background:#47bcec; color:#111; font-weight:bold; }
    .pagination span{ color:#666; user-select:none; }
  </style>
</head>

<body>
  <main class="main-content">
    <h1 class="main-title">ğŸ“œ ç·¨é›†å±¥æ­´ä¸€è¦§</h1>

    <!-- ğŸ” æ¤œç´¢ãƒ»ä¸¦ã³æ›¿ãˆ -->
    <section class="section filter-bar">
      <input type="text" id="searchInput" placeholder="ğŸ” ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ç·¨é›†è€…ãƒ»ã‚¿ã‚°ãƒ»æœˆãƒ»æ—¥ä»˜ ã§æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚ŠANDï¼‰" />
      <button id="sortBtn">â¬‡ï¸ æ›´æ–°æ—¥ é™é †</button>
    </section>

    <!-- ğŸ§± å±¥æ­´ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
    <section class="section">
      <div id="postGrid" class="post-grid"></div>
      <div id="pagination" class="pagination"></div>
    </section>
  </main>

<script>
  let historyData = [];
  let sortDesc = true;
  let currentPage = 1;
  const perPage = 30;

  const encodeToBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
  const nz = (v) => v ?? "";

  // âœ… å…¨è§’/åŠè§’/å¤§å°/ç©ºç™½ã‚’æ­£è¦åŒ–
  function normalize(text){
    return (text||"").toString().toLowerCase().normalize("NFKC").replace(/\s+/g,"");
  }

  async function loadHistory(){
    const res = await fetch("history.json?t="+Date.now(), {cache:"no-store"});
    historyData = await res.json();
    renderHistory();
  }

  function renderHistory(){
    const grid = document.getElementById("postGrid");
    const kwRaw = document.getElementById("searchInput").value.trim();
    const kws = kwRaw.split(/\s+/).map(normalize).filter(Boolean);

    // ğŸ” ANDæ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/ç·¨é›†è€…/ã‚¿ã‚°/æœˆ/æ—¥ä»˜ï¼‰
    let filtered = historyData.filter(p=>{
      const title = normalize(p.title_final || p.title_original || "");
      const editor = normalize(p.editor || "èˆ¹é•·");
      const tags = normalize((p.tags||[]).join(","));
      const month = normalize(p.month || "");
      const date  = normalize(p.date  || "");

      return kws.every(k =>
        title.includes(k) || editor.includes(k) || tags.includes(k) || month.includes(k) || date.includes(k)
      );
    });

    // ä¸¦ã³æ›¿ãˆï¼ˆæ›´æ–°æ—¥æ™‚ï¼‰
    filtered.sort((a,b)=> sortDesc
      ? new Date(b.updated_at||0) - new Date(a.updated_at||0)
      : new Date(a.updated_at||0) - new Date(b.updated_at||0)
    );

    // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
    const totalPages = Math.ceil(filtered.length / perPage);
    if (currentPage > totalPages) currentPage = totalPages || 1;
    const start = (currentPage-1)*perPage;
    const pageData = filtered.slice(start, start+perPage);

    // æç”»
    grid.innerHTML = "";
    pageData.forEach(p=>{
      const card = document.createElement("div");
      card.className = "post-card";
      const thumb = nz(p.thumb_pick1) || nz(p.thumb_original) || "no-thumb.jpg";
      card.innerHTML = `
        <img src="${thumb}" class="post-thumb" alt="thumb">
        <div class="post-info">
          <div class="post-site">${nz(p.editor) || "èˆ¹é•·"}</div>
          <div class="post-title">${nz(p.title_final) || "(ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š)"}</div>
          <div class="post-site">${nz(p.month)} ï¼ ${nz(p.date)}</div>
          <div class="btn-area">
            <button class="edit-btn"  onclick="editPost('${p.id}')">âœ ç·¨é›†</button>
            <button class="delete-btn" onclick="deletePost('${p.id}')">ğŸ—‘ å‰Šé™¤</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });

    renderPagination(totalPages);
  }

  function renderPagination(totalPages){
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    if (totalPages<=1) return;

    const mk = (label,page,dis=false,act=false)=>{
      const btn=document.createElement("button");
      btn.textContent=label;
      if(dis) btn.disabled=true;
      if(act) btn.classList.add("active");
      btn.addEventListener("click", ()=>{ currentPage=page; renderHistory(); });
      return btn;
    };

    container.appendChild(mk("â®", currentPage-1, currentPage===1));

    const range=2;
    const s=Math.max(1,currentPage-range);
    const e=Math.min(totalPages,currentPage+range);

    if(s>1){
      container.appendChild(mk("1",1));
      if(s>2){ const span=document.createElement("span"); span.textContent="â€¦"; container.appendChild(span); }
    }
    for(let i=s;i<=e;i++) container.appendChild(mk(i,i,false,i===currentPage));
    if(e<totalPages){
      if(e<totalPages-1){ const span=document.createElement("span"); span.textContent="â€¦"; container.appendChild(span); }
      container.appendChild(mk(totalPages,totalPages));
    }

    container.appendChild(mk("â­", currentPage+1, currentPage===totalPages));
  }

  // âœ å±¥æ­´ç”±æ¥ã¨ã—ã¦ edit-post ã‚’é–‹ãï¼ˆtype=historyï¼‰
  function editPost(id){
    window.location.href = `edit-post.html?id=${id}&type=history`;
  }

  // ğŸ—‘ å‰Šé™¤ï¼ˆhistory.json ã‹ã‚‰å¯¾è±¡IDã‚’é™¤å¤–ã—ã¦ä¿å­˜ï¼‰
  async function deletePost(id){
    if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try{
      const res = await fetch("history.json?t="+Date.now(), {cache:"no-store"});
      const list = await res.json();
      const updated = list.filter(p => String(p.id)!==String(id));

      const save = await fetch("https://github-writer.eda-ksuke.workers.dev", {
        method:"POST", mode:"cors",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          message:`Delete history id:${id}`,
          target:"history.json",
          content: encodeToBase64(JSON.stringify(updated, null, 2))
        })
      });

      if(save.ok){
        alert("ğŸ—‘ å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚‚åæ˜ 
        historyData = updated;
        renderHistory();
      }else{
        alert("âš ï¸ å‰Šé™¤å¤±æ•—: "+save.status);
      }
    }catch(e){
      console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
      alert("âš ï¸ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  }

  // UIã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById("searchInput").addEventListener("input", ()=>{
    currentPage = 1;
    renderHistory();
  });
  document.getElementById("sortBtn").addEventListener("click", ()=>{
    sortDesc = !sortDesc;
    document.getElementById("sortBtn").textContent = sortDesc ? "â¬‡ï¸ æ›´æ–°æ—¥ é™é †" : "â¬†ï¸ æ›´æ–°æ—¥ æ˜‡é †";
    renderHistory();
  });

  loadHistory();
</script>
</body>
</html>
