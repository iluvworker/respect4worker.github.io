<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“œ åŠŸç¸¾ä¸€è¦§</title>
  <link rel="stylesheet" href="assets/style.css?v=8">
  <script src="assets/sidebar.js" defer></script>

  <style>
    /* ===== ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    .post-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; }
    .post-card { background:#1e1e1e; border-radius:10px; overflow:hidden; box-shadow:0 0 6px rgba(0,0,0,.4); transition:.2s; display:flex; flex-direction:column; }
    .post-card:hover { transform: translateY(-3px); }
    .post-thumb { width:100%; height:180px; object-fit:cover; background:#111; }
    .post-info { padding:15px; display:flex; flex-direction:column; gap:6px; }
    .post-site { color:#47bcec; font-size:14px; font-weight:700; }
    .post-title { font-size:16px; color:#fff; text-decoration:none; }
    .post-title:hover { color:#5fd0ff; }
    .btn-area { display:flex; gap:8px; margin-top:10px; }
    .edit-btn,.delete-btn{ flex:1; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; }
    .edit-btn{ background:#47bcec; color:#111; } .edit-btn:hover{ background:#5fd0ff; }
    .delete-btn{ background:#ff4d4d; color:#fff; } .delete-btn:hover{ background:#ff6666; }

    /* ===== æ¤œç´¢ãƒãƒ¼ ===== */
    .filter-bar{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px; margin-bottom:20px; }
    #searchInput{ flex:1; padding:10px; border-radius:6px; border:none; background:#1e1e1e; color:#eee; font-size:15px; }
    #sortBtn{ background:#333; border:1px solid #47bcec; color:#47bcec; padding:8px 12px; border-radius:6px; cursor:pointer; }
    #sortBtn:hover{ background:#47bcec; color:#111; }

    /* ===== ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ ===== */
    .pagination{ display:flex; justify-content:center; align-items:center; margin-top:30px; gap:8px; flex-wrap:wrap; }
    .pagination button{ background:#1e1e1e; border:1px solid #47bcec; color:#47bcec; padding:6px 10px; border-radius:5px; cursor:pointer; min-width:32px; transition:.2s; }
    .pagination button:hover{ background:#47bcec; color:#111; }
    .pagination button.active{ background:#47bcec; color:#111; font-weight:bold; }
    .pagination span{ color:#666; user-select:none; }
  </style>
</head>

<body>
  <main class="main-content">
    <h1 class="main-title">ğŸ“œ åŠŸç¸¾ä¸€è¦§</h1>

    <!-- ğŸ” æ¤œç´¢ãƒ»ä¸¦ã³æ›¿ãˆ -->
    <section class="section filter-bar">
      <input type="text" id="searchInput" placeholder="ğŸ” ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ç·¨é›†è€…ãƒ»ã‚¿ã‚°ãƒ»æœˆãƒ»æ—¥ä»˜ ã§æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚ŠANDï¼‰" />
      <button id="sortBtn">â¬‡ï¸ æ›´æ–°æ—¥ é™é †</button>
    </section>
    <p id="resultCount" style="color:#aaa;font-size:14px;margin:6px 0 16px 0;">
  æ¤œç´¢çµæœï¼š0ä»¶
</p>

    <!-- ğŸ§± å±¥æ­´ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
    <section class="section">
      <div id="postGrid" class="post-grid"></div>
      <div id="pagination" class="pagination"></div>
    </section>
  </main>

<script>
  let historyData = [];
  let sortDesc = true;
  let currentPage = 1;
  const perPage = 30;

  const encodeToBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
  const nz = (v) => v ?? "";

  // âœ… å…¨è§’/åŠè§’/å¤§å°/ç©ºç™½ã‚’æ­£è¦åŒ–
  function normalize(text){
    return (text||"").toString().toLowerCase().normalize("NFKC").replace(/\s+/g,"");
  }

function renderHistory(){
  const grid = document.getElementById("postGrid");
  const kwRaw = document.getElementById("searchInput").value.trim();
  const kws = kwRaw.split(/\s+/).map(normalize).filter(Boolean);

  // ğŸ” ANDæ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ« / ç·¨é›†è€… / ã‚¿ã‚° / æ—¥ä»˜æ–‡å­—åˆ—ï¼‰
  let filtered = historyData.filter(p=>{
    const title  = normalize(p.title_final || p.title_original || "");
    const editor = normalize(p.editor || "èˆ¹é•·");
    const tags   = normalize((p.tags||[]).join(","));

    // æ—¥ä»˜ã‚’ã€Œ10æœˆã€ã€Œ2025ã€ã€Œ10/20ã€ã©ã‚Œã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«
    const dates = [p.updated_at, p.posted_at]
      .filter(Boolean)
      .map(d => {
        const date = new Date(d);
        return normalize(
          `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${date.getMonth()+1}/${date.getDate()}`
        );
      })
      .join(" ");

    return kws.every(k =>
      title.includes(k) || editor.includes(k) || tags.includes(k) || dates.includes(k)
    );
  });

  // ä¸¦ã³æ›¿ãˆï¼ˆæ›´æ–°æ—¥æ™‚ï¼‰
  filtered.sort((a,b)=> sortDesc
    ? new Date(b.updated_at||0) - new Date(a.updated_at||0)
    : new Date(a.updated_at||0) - new Date(b.updated_at||0)
  );

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  const totalPages = Math.ceil(filtered.length / perPage);
  if (currentPage > totalPages) currentPage = totalPages || 1;
  const start = (currentPage-1)*perPage;
  const pageData = filtered.slice(start, start+perPage);

  // ä»¶æ•°ã‚’è¡¨ç¤ºï¼ˆã“ã“ãŒæ­£ã—ã„ä½ç½®ï¼‰
  const countEl = document.getElementById("resultCount");
  if (countEl) {
    countEl.textContent = `æ¤œç´¢çµæœï¼š${filtered.length}ä»¶`;}

  // æç”»
  grid.innerHTML = "";
  pageData.forEach(p=>{
    const card = document.createElement("div");
    card.className = "post-card";
    const thumb = nz(p.thumb_pick1) || nz(p.thumb_original) || "no-thumb.jpg";
    card.innerHTML = `
      <img src="${thumb}" class="post-thumb" alt="thumb">
      <div class="post-info">
        <div class="post-site">${nz(p.editor) || "èˆ¹é•·"}</div>
        <div class="post-title">${nz(p.title_final) || "(ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®š)"}</div>
        <div class="post-site">${nz(p.month)} ï¼ ${nz(p.date)}</div>
        
      </div>
    `;
    grid.appendChild(card);
  });

  renderPagination(totalPages);
}

  function renderPagination(totalPages){
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    if (totalPages<=1) return;

    const mk = (label,page,dis=false,act=false)=>{
      const btn=document.createElement("button");
      btn.textContent=label;
      if(dis) btn.disabled=true;
      if(act) btn.classList.add("active");
      btn.addEventListener("click", ()=>{ currentPage=page; renderHistory(); });
      return btn;
    };

    container.appendChild(mk("â®", currentPage-1, currentPage===1));

    const range=2;
    const s=Math.max(1,currentPage-range);
    const e=Math.min(totalPages,currentPage+range);

    if(s>1){
      container.appendChild(mk("1",1));
      if(s>2){ const span=document.createElement("span"); span.textContent="â€¦"; container.appendChild(span); }
    }
    for(let i=s;i<=e;i++) container.appendChild(mk(i,i,false,i===currentPage));
    if(e<totalPages){
      if(e<totalPages-1){ const span=document.createElement("span"); span.textContent="â€¦"; container.appendChild(span); }
      container.appendChild(mk(totalPages,totalPages));
    }

    container.appendChild(mk("â­", currentPage+1, currentPage===totalPages));
  }

  // âœ å±¥æ­´ç”±æ¥ã¨ã—ã¦ edit-history ã‚’é–‹ãï¼ˆtype=historyï¼‰
// âœ å±¥æ­´ç·¨é›†ãƒšãƒ¼ã‚¸ã«é·ç§»ï¼ˆhistory.json ã‚’å‚ç…§ï¼‰
function editPost(id){
  window.location.href = `edit-history.html?id=${id}&type=history`;
}
// âœ… ã‚¯ãƒ«ãƒ¼åŠŸç¸¾ãƒšãƒ¼ã‚¸ç”¨ï¼šçµ¶å¯¾URLã§å®‰å…¨ã«fetch
async function loadCrewHistory() {
  const user = JSON.parse(localStorage.getItem("loginUser"));
  console.log("ğŸ§© loginUser:", user);
  const currentUser = (user?.name || user?.username || user?.id || "").trim();

  // âœ… ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
  document.querySelector(".main-title").textContent = `ğŸ“œ ${currentUser} ã®åŠŸç¸¾ä¸€è¦§`;

  // âœ… ãƒ™ãƒ¼ã‚¹URLã‚’å®Œå…¨æŒ‡å®šï¼ˆã“ã‚Œã§404å›é¿ï¼‰
  const base = `${location.origin}/respect4worker.github.io/`;
  const sources = [`${base}history.json`, `${base}posted.json`];

  let allList = [];

  for (const src of sources) {
    try {
      const res = await fetch(src + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(res.statusText);
      let data = await res.json();
      while (Array.isArray(data[0])) data = data.flat();
      allList.push(...data);
    } catch (e) {
      console.warn(src + " ã®å–å¾—ã«å¤±æ•—:", e);
    }
  }

  // âœ… ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å›ºå®šåŸºæº–ã«æŠ½å‡º
const myList = allList.filter(p => {
  const whoId = (p.editor_id || "").trim();
  const whoName = (p.editor || "").trim();
  return whoId === user.id || whoName === user.name;
});

  if (!myList.length) {
    console.warn("âš ï¸ è©²å½“ã™ã‚‹åŠŸç¸¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", currentUser);
  }

  // âœ… ãƒ‡ãƒ¼ã‚¿åæ˜ 
  historyData = myList;
  renderHistory();
}

// ğŸ§­ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
document.getElementById("searchInput").addEventListener("input", () => {
  currentPage = 1;
  renderHistory();
});
document.getElementById("sortBtn").addEventListener("click", () => {
  sortDesc = !sortDesc;
  document.getElementById("sortBtn").textContent = sortDesc ? "â¬‡ï¸ æ›´æ–°æ—¥ é™é †" : "â¬†ï¸ æ›´æ–°æ—¥ æ˜‡é †";
  renderHistory();
});

// ğŸ”¥ å®Ÿè¡Œ
loadCrewHistory();
</script>
</body>
</html>
