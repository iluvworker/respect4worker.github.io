<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📜 功績一覧</title>
  <link rel="stylesheet" href="assets/style.css?v=8">
  <script src="assets/sidebar.js" defer></script>

  <style>
    /* ===== カードレイアウト ===== */
    .post-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; }
    .post-card { background:#1e1e1e; border-radius:10px; overflow:hidden; box-shadow:0 0 6px rgba(0,0,0,.4); transition:.2s; display:flex; flex-direction:column; }
    .post-card:hover { transform: translateY(-3px); }
    .post-thumb { width:100%; height:180px; object-fit:cover; background:#111; }
    .post-info { padding:15px; display:flex; flex-direction:column; gap:6px; }
    .post-site { color:#47bcec; font-size:14px; font-weight:700; }
    .post-title { font-size:16px; color:#fff; text-decoration:none; }
    .post-title:hover { color:#5fd0ff; }
    .btn-area { display:flex; gap:8px; margin-top:10px; }
    .edit-btn,.delete-btn{ flex:1; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; }
    .edit-btn{ background:#47bcec; color:#111; } .edit-btn:hover{ background:#5fd0ff; }
    .delete-btn{ background:#ff4d4d; color:#fff; } .delete-btn:hover{ background:#ff6666; }

    /* ===== 検索バー ===== */
    .filter-bar{ display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px; margin-bottom:20px; }
    #searchInput{ flex:1; padding:10px; border-radius:6px; border:none; background:#1e1e1e; color:#eee; font-size:15px; }
    #sortBtn{ background:#333; border:1px solid #47bcec; color:#47bcec; padding:8px 12px; border-radius:6px; cursor:pointer; }
    #sortBtn:hover{ background:#47bcec; color:#111; }

    /* ===== ページネーション ===== */
    .pagination{ display:flex; justify-content:center; align-items:center; margin-top:30px; gap:8px; flex-wrap:wrap; }
    .pagination button{ background:#1e1e1e; border:1px solid #47bcec; color:#47bcec; padding:6px 10px; border-radius:5px; cursor:pointer; min-width:32px; transition:.2s; }
    .pagination button:hover{ background:#47bcec; color:#111; }
    .pagination button.active{ background:#47bcec; color:#111; font-weight:bold; }
    .pagination span{ color:#666; user-select:none; }
  </style>
</head>

<body>
  <main class="main-content">
    <h1 class="main-title">📜 功績一覧</h1>

    <!-- 🔍 検索・並び替え -->
    <section class="section filter-bar">
      <input type="text" id="searchInput" placeholder="🔍 タイトル・編集者・タグ・月・日付 で検索（スペース区切りAND）" />
      <button id="sortBtn">⬇️ 更新日 降順</button>
    </section>
    <p id="resultCount" style="color:#aaa;font-size:14px;margin:6px 0 16px 0;">
  検索結果：0件
</p>

    <!-- 🧱 履歴カード一覧 -->
    <section class="section">
      <div id="postGrid" class="post-grid"></div>
      <div id="pagination" class="pagination"></div>
    </section>
  </main>

<script>
  let historyData = [];
  let sortDesc = true;
  let currentPage = 1;
  const perPage = 30;

  const encodeToBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
  const nz = (v) => v ?? "";

  // ✅ 全角/半角/大小/空白を正規化
  function normalize(text){
    return (text||"").toString().toLowerCase().normalize("NFKC").replace(/\s+/g,"");
  }

function renderHistory(){
  const grid = document.getElementById("postGrid");
  const kwRaw = document.getElementById("searchInput").value.trim();
  const kws = kwRaw.split(/\s+/).map(normalize).filter(Boolean);

  // 🔎 AND検索（タイトル / 編集者 / タグ / 日付文字列）
  let filtered = historyData.filter(p=>{
    const title  = normalize(p.title_final || p.title_original || "");
    const editor = normalize(p.editor || "船長");
    const tags   = normalize((p.tags||[]).join(","));

    // 日付を「10月」「2025」「10/20」どれでも拾えるように
    const dates = [p.updated_at, p.posted_at]
      .filter(Boolean)
      .map(d => {
        const date = new Date(d);
        return normalize(
          `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 ${date.getMonth()+1}/${date.getDate()}`
        );
      })
      .join(" ");

    return kws.every(k =>
      title.includes(k) || editor.includes(k) || tags.includes(k) || dates.includes(k)
    );
  });

  // 並び替え（更新日時）
  filtered.sort((a,b)=> sortDesc
    ? new Date(b.updated_at||0) - new Date(a.updated_at||0)
    : new Date(a.updated_at||0) - new Date(b.updated_at||0)
  );

  // ページング
  const totalPages = Math.ceil(filtered.length / perPage);
  if (currentPage > totalPages) currentPage = totalPages || 1;
  const start = (currentPage-1)*perPage;
  const pageData = filtered.slice(start, start+perPage);

  // 件数を表示（ここが正しい位置）
  const countEl = document.getElementById("resultCount");
  if (countEl) {
    countEl.textContent = `検索結果：${filtered.length}件`;}

  // 描画
  grid.innerHTML = "";
  pageData.forEach(p=>{
    const card = document.createElement("div");
    card.className = "post-card";
    const thumb = nz(p.thumb_pick1) || nz(p.thumb_original) || "no-thumb.jpg";
    card.innerHTML = `
      <img src="${thumb}" class="post-thumb" alt="thumb">
      <div class="post-info">
        <div class="post-site">${nz(p.editor) || "船長"}</div>
        <div class="post-title">${nz(p.title_final) || "(タイトル未設定)"}</div>
        <div class="post-site">${nz(p.month)} ／ ${nz(p.date)}</div>
        
      </div>
    `;
    grid.appendChild(card);
  });

  renderPagination(totalPages);
}

  function renderPagination(totalPages){
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    if (totalPages<=1) return;

    const mk = (label,page,dis=false,act=false)=>{
      const btn=document.createElement("button");
      btn.textContent=label;
      if(dis) btn.disabled=true;
      if(act) btn.classList.add("active");
      btn.addEventListener("click", ()=>{ currentPage=page; renderHistory(); });
      return btn;
    };

    container.appendChild(mk("⏮", currentPage-1, currentPage===1));

    const range=2;
    const s=Math.max(1,currentPage-range);
    const e=Math.min(totalPages,currentPage+range);

    if(s>1){
      container.appendChild(mk("1",1));
      if(s>2){ const span=document.createElement("span"); span.textContent="…"; container.appendChild(span); }
    }
    for(let i=s;i<=e;i++) container.appendChild(mk(i,i,false,i===currentPage));
    if(e<totalPages){
      if(e<totalPages-1){ const span=document.createElement("span"); span.textContent="…"; container.appendChild(span); }
      container.appendChild(mk(totalPages,totalPages));
    }

    container.appendChild(mk("⏭", currentPage+1, currentPage===totalPages));
  }

  // ✏ 履歴由来として edit-history を開く（type=history）
// ✏ 履歴編集ページに遷移（history.json を参照）
function editPost(id){
  window.location.href = `edit-history.html?id=${id}&type=history`;
}
// ✅ クルー功績ページ用：絶対URLで安全にfetch
async function loadCrewHistory() {
  const user = JSON.parse(localStorage.getItem("loginUser"));
  console.log("🧩 loginUser:", user);
  const currentUser = (user?.name || user?.username || user?.id || "").trim();

  // ✅ ページタイトル更新
  document.querySelector(".main-title").textContent = `📜 ${currentUser} の功績一覧`;

  // ✅ ベースURLを完全指定（これで404回避）
  const base = `${location.origin}/respect4worker.github.io/`;
  const sources = [`${base}history.json`, `${base}posted.json`];

  let allList = [];

  for (const src of sources) {
    try {
      const res = await fetch(src + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error(res.statusText);
      let data = await res.json();
      while (Array.isArray(data[0])) data = data.flat();
      allList.push(...data);
    } catch (e) {
      console.warn(src + " の取得に失敗:", e);
    }
  }

  // ✅ 現在ログイン中のユーザー名を固定基準に抽出
const myList = allList.filter(p => {
  const whoId = (p.editor_id || "").trim();
  const whoName = (p.editor || "").trim();
  return whoId === user.id || whoName === user.name;
});

  if (!myList.length) {
    console.warn("⚠️ 該当する功績が見つかりません:", currentUser);
  }

  // ✅ データ反映
  historyData = myList;
  renderHistory();
}

// 🧭 イベントバインド
document.getElementById("searchInput").addEventListener("input", () => {
  currentPage = 1;
  renderHistory();
});
document.getElementById("sortBtn").addEventListener("click", () => {
  sortDesc = !sortDesc;
  document.getElementById("sortBtn").textContent = sortDesc ? "⬇️ 更新日 降順" : "⬆️ 更新日 昇順";
  renderHistory();
});

// 🔥 実行
loadCrewHistory();
</script>
</body>
</html>
